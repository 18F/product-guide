{"version":3,"file":"Atlas.js","sources":["../../../src/ol/style/Atlas.js"],"sourcesContent":["/**\n * @module ol/style/Atlas\n */\nimport {createCanvasContext2D} from '../dom.js';\n\n\n/**\n * @typedef {Object} AtlasBlock\n * @property {number} x\n * @property {number} y\n * @property {number} width\n * @property {number} height\n */\n\n/**\n * Provides information for an image inside an atlas.\n * `offsetX` and `offsetY` are the position of the image inside the atlas image `image`.\n * @typedef {Object} AtlasInfo\n * @property {number} offsetX\n * @property {number} offsetY\n * @property {HTMLCanvasElement} image\n */\n\n\n/**\n * @classesc\n * This class facilitates the creation of image atlases.\n *\n * Images added to an atlas will be rendered onto a single\n * atlas canvas. The distribution of images on the canvas is\n * managed with the bin packing algorithm described in:\n * http://www.blackpawn.com/texts/lightmaps/\n *\n * @param {number} size The size in pixels of the sprite image.\n * @param {number} space The space in pixels between images.\n *    Because texture coordinates are float values, the edges of\n *    images might not be completely correct (in a way that the\n *    edges overlap when being rendered). To avoid this we add a\n *    padding around each image.\n */\nclass Atlas {\n\n  /**\n   * @param {number} size The size in pixels of the sprite image.\n   * @param {number} space The space in pixels between images.\n   *    Because texture coordinates are float values, the edges of\n   *    images might not be completely correct (in a way that the\n   *    edges overlap when being rendered). To avoid this we add a\n   *    padding around each image.\n   */\n  constructor(size, space) {\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.space_ = space;\n\n    /**\n     * @private\n     * @type {Array<AtlasBlock>}\n     */\n    this.emptyBlocks_ = [{x: 0, y: 0, width: size, height: size}];\n\n    /**\n     * @private\n     * @type {Object<string, AtlasInfo>}\n     */\n    this.entries_ = {};\n\n    /**\n     * @private\n     * @type {CanvasRenderingContext2D}\n     */\n    this.context_ = createCanvasContext2D(size, size);\n\n    /**\n     * @private\n     * @type {HTMLCanvasElement}\n     */\n    this.canvas_ = this.context_.canvas;\n  }\n\n  /**\n   * @param {string} id The identifier of the entry to check.\n   * @return {?AtlasInfo} The atlas info.\n   */\n  get(id) {\n    return this.entries_[id] || null;\n  }\n\n  /**\n   * @param {string} id The identifier of the entry to add.\n   * @param {number} width The width.\n   * @param {number} height The height.\n   * @param {function(CanvasRenderingContext2D, number, number)} renderCallback\n   *    Called to render the new image onto an atlas image.\n   * @param {Object=} opt_this Value to use as `this` when executing\n   *    `renderCallback`.\n   * @return {?AtlasInfo} The position and atlas image for the entry.\n   */\n  add(id, width, height, renderCallback, opt_this) {\n    for (let i = 0, ii = this.emptyBlocks_.length; i < ii; ++i) {\n      const block = this.emptyBlocks_[i];\n      if (block.width >= width + this.space_ &&\n          block.height >= height + this.space_) {\n        // we found a block that is big enough for our entry\n        const entry = {\n          offsetX: block.x + this.space_,\n          offsetY: block.y + this.space_,\n          image: this.canvas_\n        };\n        this.entries_[id] = entry;\n\n        // render the image on the atlas image\n        renderCallback.call(opt_this, this.context_,\n          block.x + this.space_, block.y + this.space_);\n\n        // split the block after the insertion, either horizontally or vertically\n        this.split_(i, block, width + this.space_, height + this.space_);\n\n        return entry;\n      }\n    }\n\n    // there is no space for the new entry in this atlas\n    return null;\n  }\n\n  /**\n   * @private\n   * @param {number} index The index of the block.\n   * @param {AtlasBlock} block The block to split.\n   * @param {number} width The width of the entry to insert.\n   * @param {number} height The height of the entry to insert.\n   */\n  split_(index, block, width, height) {\n    const deltaWidth = block.width - width;\n    const deltaHeight = block.height - height;\n\n    /** @type {AtlasBlock} */\n    let newBlock1;\n    /** @type {AtlasBlock} */\n    let newBlock2;\n\n    if (deltaWidth > deltaHeight) {\n      // split vertically\n      // block right of the inserted entry\n      newBlock1 = {\n        x: block.x + width,\n        y: block.y,\n        width: block.width - width,\n        height: block.height\n      };\n\n      // block below the inserted entry\n      newBlock2 = {\n        x: block.x,\n        y: block.y + height,\n        width: width,\n        height: block.height - height\n      };\n      this.updateBlocks_(index, newBlock1, newBlock2);\n    } else {\n      // split horizontally\n      // block right of the inserted entry\n      newBlock1 = {\n        x: block.x + width,\n        y: block.y,\n        width: block.width - width,\n        height: height\n      };\n\n      // block below the inserted entry\n      newBlock2 = {\n        x: block.x,\n        y: block.y + height,\n        width: block.width,\n        height: block.height - height\n      };\n      this.updateBlocks_(index, newBlock1, newBlock2);\n    }\n  }\n\n  /**\n   * Remove the old block and insert new blocks at the same array position.\n   * The new blocks are inserted at the same position, so that splitted\n   * blocks (that are potentially smaller) are filled first.\n   * @private\n   * @param {number} index The index of the block to remove.\n   * @param {AtlasBlock} newBlock1 The 1st block to add.\n   * @param {AtlasBlock} newBlock2 The 2nd block to add.\n   */\n  updateBlocks_(index, newBlock1, newBlock2) {\n    const args = /** @type {Array<*>} */ ([index, 1]);\n    if (newBlock1.width > 0 && newBlock1.height > 0) {\n      args.push(newBlock1);\n    }\n    if (newBlock2.width > 0 && newBlock2.height > 0) {\n      args.push(newBlock2);\n    }\n    this.emptyBlocks_.splice.apply(this.emptyBlocks_, args);\n  }\n}\n\nexport default Atlas;\n"],"names":["let","const"],"mappings":"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"}