{"version":3,"file":"AtlasManager.js","sources":["../../../src/ol/style/AtlasManager.js"],"sourcesContent":["/**\n * @module ol/style/AtlasManager\n */\nimport {MAX_TEXTURE_SIZE as WEBGL_MAX_TEXTURE_SIZE} from '../webgl.js';\nimport {VOID} from '../functions.js';\nimport Atlas from './Atlas.js';\n\n\n/**\n * @typedef {Object} Options\n * @property {number} [initialSize=256] The size in pixels of the first atlas image.\n * @property {number} [maxSize] The maximum size in pixels of atlas images. Default is\n * `webgl/MAX_TEXTURE_SIZE` or 2048 if WebGL is not supported.\n * @property {number} [space=1] The space in pixels between images.\n */\n\n\n/**\n * Provides information for an image inside an atlas manager.\n * `offsetX` and `offsetY` is the position of the image inside\n * the atlas image `image` and the position of the hit-detection image\n * inside the hit-detection atlas image `hitImage`.\n * @typedef {Object} AtlasManagerInfo\n * @property {number} offsetX\n * @property {number} offsetY\n * @property {HTMLCanvasElement} image\n * @property {HTMLCanvasElement} hitImage\n */\n\n\n/**\n * The size in pixels of the first atlas image.\n * @type {number}\n */\nconst INITIAL_ATLAS_SIZE = 256;\n\n/**\n * The maximum size in pixels of atlas images.\n * @type {number}\n */\nconst MAX_ATLAS_SIZE = -1;\n\n\n/**\n * @classdesc\n * Manages the creation of image atlases.\n *\n * Images added to this manager will be inserted into an atlas, which\n * will be used for rendering.\n * The `size` given in the constructor is the size for the first\n * atlas. After that, when new atlases are created, they will have\n * twice the size as the latest atlas (until `maxSize` is reached).\n *\n * If an application uses many images or very large images, it is recommended\n * to set a higher `size` value to avoid the creation of too many atlases.\n * @api\n */\nclass AtlasManager {\n  /**\n   * @param {Options=} opt_options Options.\n   */\n  constructor(opt_options) {\n\n    const options = opt_options || {};\n\n    /**\n     * The size in pixels of the latest atlas image.\n     * @private\n     * @type {number}\n     */\n    this.currentSize_ = options.initialSize !== undefined ?\n      options.initialSize : INITIAL_ATLAS_SIZE;\n\n    /**\n     * The maximum size in pixels of atlas images.\n     * @private\n     * @type {number}\n     */\n    this.maxSize_ = options.maxSize !== undefined ?\n      options.maxSize : MAX_ATLAS_SIZE != -1 ?\n        MAX_ATLAS_SIZE : WEBGL_MAX_TEXTURE_SIZE !== undefined ?\n          WEBGL_MAX_TEXTURE_SIZE : 2048;\n\n    /**\n     * The size in pixels between images.\n     * @private\n     * @type {number}\n     */\n    this.space_ = options.space !== undefined ? options.space : 1;\n\n    /**\n     * @private\n     * @type {Array<import(\"./Atlas.js\").default>}\n     */\n    this.atlases_ = [new Atlas(this.currentSize_, this.space_)];\n\n    /**\n     * The size in pixels of the latest atlas image for hit-detection images.\n     * @private\n     * @type {number}\n     */\n    this.currentHitSize_ = this.currentSize_;\n\n    /**\n     * @private\n     * @type {Array<import(\"./Atlas.js\").default>}\n     */\n    this.hitAtlases_ = [new Atlas(this.currentHitSize_, this.space_)];\n  }\n\n  /**\n   * @param {string} id The identifier of the entry to check.\n   * @return {?AtlasManagerInfo} The position and atlas image for the\n   *    entry, or `null` if the entry is not part of the atlas manager.\n   */\n  getInfo(id) {\n    /** @type {?import(\"./Atlas.js\").AtlasInfo} */\n    const info = this.getInfo_(this.atlases_, id);\n\n    if (!info) {\n      return null;\n    }\n    const hitInfo = /** @type {import(\"./Atlas.js\").AtlasInfo} */ (this.getInfo_(this.hitAtlases_, id));\n\n    return this.mergeInfos_(info, hitInfo);\n  }\n\n  /**\n   * @private\n   * @param {Array<import(\"./Atlas.js\").default>} atlases The atlases to search.\n   * @param {string} id The identifier of the entry to check.\n   * @return {?import(\"./Atlas.js\").AtlasInfo} The position and atlas image for the entry,\n   *    or `null` if the entry is not part of the atlases.\n   */\n  getInfo_(atlases, id) {\n    for (let i = 0, ii = atlases.length; i < ii; ++i) {\n      const atlas = atlases[i];\n      const info = atlas.get(id);\n      if (info) {\n        return info;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * @private\n   * @param {import(\"./Atlas.js\").AtlasInfo} info The info for the real image.\n   * @param {import(\"./Atlas.js\").AtlasInfo} hitInfo The info for the hit-detection\n   *    image.\n   * @return {?AtlasManagerInfo} The position and atlas image for the\n   *    entry, or `null` if the entry is not part of the atlases.\n   */\n  mergeInfos_(info, hitInfo) {\n    return (\n      /** @type {AtlasManagerInfo} */ ({\n        offsetX: info.offsetX,\n        offsetY: info.offsetY,\n        image: info.image,\n        hitImage: hitInfo.image\n      })\n    );\n  }\n\n  /**\n   * Add an image to the atlas manager.\n   *\n   * If an entry for the given id already exists, the entry will\n   * be overridden (but the space on the atlas graphic will not be freed).\n   *\n   * If `renderHitCallback` is provided, the image (or the hit-detection version\n   * of the image) will be rendered into a separate hit-detection atlas image.\n   *\n   * @param {string} id The identifier of the entry to add.\n   * @param {number} width The width.\n   * @param {number} height The height.\n   * @param {function(CanvasRenderingContext2D, number, number)} renderCallback\n   *    Called to render the new image onto an atlas image.\n   * @param {function(CanvasRenderingContext2D, number, number)=} opt_renderHitCallback Called to render a hit-detection image onto a hit\n   *    detection atlas image.\n   * @param {Object=} opt_this Value to use as `this` when executing\n   *    `renderCallback` and `renderHitCallback`.\n   * @return {?AtlasManagerInfo}  The position and atlas image for the\n   *    entry, or `null` if the image is too big.\n   */\n  add(id, width, height, renderCallback, opt_renderHitCallback, opt_this) {\n    if (width + this.space_ > this.maxSize_ ||\n        height + this.space_ > this.maxSize_) {\n      return null;\n    }\n\n    /** @type {?import(\"./Atlas.js\").AtlasInfo} */\n    const info = this.add_(false, id, width, height, renderCallback, opt_this);\n    if (!info) {\n      return null;\n    }\n\n    // even if no hit-detection entry is requested, we insert a fake entry into\n    // the hit-detection atlas, to make sure that the offset is the same for\n    // the original image and the hit-detection image.\n    const renderHitCallback = opt_renderHitCallback !== undefined ?\n      opt_renderHitCallback : VOID;\n\n    const hitInfo = /** @type {import(\"./Atlas.js\").AtlasInfo} */ (this.add_(true,\n      id, width, height, renderHitCallback, opt_this));\n\n    return this.mergeInfos_(info, hitInfo);\n  }\n\n  /**\n   * @private\n   * @param {boolean} isHitAtlas If the hit-detection atlases are used.\n   * @param {string} id The identifier of the entry to add.\n   * @param {number} width The width.\n   * @param {number} height The height.\n   * @param {function(CanvasRenderingContext2D, number, number)} renderCallback\n   *    Called to render the new image onto an atlas image.\n   * @param {Object=} opt_this Value to use as `this` when executing\n   *    `renderCallback` and `renderHitCallback`.\n   * @return {?import(\"./Atlas.js\").AtlasInfo}  The position and atlas image for the entry,\n   *    or `null` if the image is too big.\n   */\n  add_(isHitAtlas, id, width, height, renderCallback, opt_this) {\n    const atlases = (isHitAtlas) ? this.hitAtlases_ : this.atlases_;\n    let atlas, info, i, ii;\n    for (i = 0, ii = atlases.length; i < ii; ++i) {\n      atlas = atlases[i];\n      info = atlas.add(id, width, height, renderCallback, opt_this);\n      if (info) {\n        return info;\n      } else if (!info && i === ii - 1) {\n        // the entry could not be added to one of the existing atlases,\n        // create a new atlas that is twice as big and try to add to this one.\n        let size;\n        if (isHitAtlas) {\n          size = Math.min(this.currentHitSize_ * 2, this.maxSize_);\n          this.currentHitSize_ = size;\n        } else {\n          size = Math.min(this.currentSize_ * 2, this.maxSize_);\n          this.currentSize_ = size;\n        }\n        atlas = new Atlas(size, this.space_);\n        atlases.push(atlas);\n        // run the loop another time\n        ++ii;\n      }\n    }\n    return null;\n  }\n}\n\nexport default AtlasManager;\n"],"names":["const","let"],"mappings":"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"}