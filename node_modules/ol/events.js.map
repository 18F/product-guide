{"version":3,"file":"events.js","sources":["../../src/ol/events.js"],"sourcesContent":["/**\n * @module ol/events\n */\nimport {clear} from './obj.js';\n\n\n/**\n * Key to use with {@link module:ol/Observable~Observable#unByKey}.\n * @typedef {Object} EventsKey\n * @property {Object} [bindTo]\n * @property {ListenerFunction} [boundListener]\n * @property {boolean} callOnce\n * @property {number} [deleteIndex]\n * @property {ListenerFunction} listener\n * @property {import(\"./events/Target.js\").EventTargetLike} target\n * @property {string} type\n * @api\n */\n\n\n/**\n * Listener function. This function is called with an event object as argument.\n * When the function returns `false`, event propagation will stop.\n *\n * @typedef {function((Event|import(\"./events/Event.js\").default)): (void|boolean)} ListenerFunction\n * @api\n */\n\n\n/**\n * @param {EventsKey} listenerObj Listener object.\n * @return {ListenerFunction} Bound listener.\n */\nexport function bindListener(listenerObj) {\n  const boundListener = function(evt) {\n    const listener = listenerObj.listener;\n    const bindTo = listenerObj.bindTo || listenerObj.target;\n    if (listenerObj.callOnce) {\n      unlistenByKey(listenerObj);\n    }\n    return listener.call(bindTo, evt);\n  };\n  listenerObj.boundListener = boundListener;\n  return boundListener;\n}\n\n\n/**\n * Finds the matching {@link module:ol/events~EventsKey} in the given listener\n * array.\n *\n * @param {!Array<!EventsKey>} listeners Array of listeners.\n * @param {!Function} listener The listener function.\n * @param {Object=} opt_this The `this` value inside the listener.\n * @param {boolean=} opt_setDeleteIndex Set the deleteIndex on the matching\n *     listener, for {@link module:ol/events~unlistenByKey}.\n * @return {EventsKey|undefined} The matching listener object.\n */\nexport function findListener(listeners, listener, opt_this, opt_setDeleteIndex) {\n  let listenerObj;\n  for (let i = 0, ii = listeners.length; i < ii; ++i) {\n    listenerObj = listeners[i];\n    if (listenerObj.listener === listener &&\n        listenerObj.bindTo === opt_this) {\n      if (opt_setDeleteIndex) {\n        listenerObj.deleteIndex = i;\n      }\n      return listenerObj;\n    }\n  }\n  return undefined;\n}\n\n\n/**\n * @param {import(\"./events/Target.js\").EventTargetLike} target Target.\n * @param {string} type Type.\n * @return {Array<EventsKey>|undefined} Listeners.\n */\nexport function getListeners(target, type) {\n  const listenerMap = getListenerMap(target);\n  return listenerMap ? listenerMap[type] : undefined;\n}\n\n\n/**\n * Get the lookup of listeners.\n * @param {Object} target Target.\n * @param {boolean=} opt_create If a map should be created if it doesn't exist.\n * @return {!Object<string, Array<EventsKey>>} Map of\n *     listeners by event type.\n */\nfunction getListenerMap(target, opt_create) {\n  let listenerMap = target.ol_lm;\n  if (!listenerMap && opt_create) {\n    listenerMap = target.ol_lm = {};\n  }\n  return listenerMap;\n}\n\n\n/**\n * Remove the listener map from a target.\n * @param {Object} target Target.\n */\nfunction removeListenerMap(target) {\n  delete target.ol_lm;\n}\n\n\n/**\n * Clean up all listener objects of the given type.  All properties on the\n * listener objects will be removed, and if no listeners remain in the listener\n * map, it will be removed from the target.\n * @param {import(\"./events/Target.js\").EventTargetLike} target Target.\n * @param {string} type Type.\n */\nfunction removeListeners(target, type) {\n  const listeners = getListeners(target, type);\n  if (listeners) {\n    for (let i = 0, ii = listeners.length; i < ii; ++i) {\n      /** @type {import(\"./events/Target.js\").default} */ (target).\n        removeEventListener(type, listeners[i].boundListener);\n      clear(listeners[i]);\n    }\n    listeners.length = 0;\n    const listenerMap = getListenerMap(target);\n    if (listenerMap) {\n      delete listenerMap[type];\n      if (Object.keys(listenerMap).length === 0) {\n        removeListenerMap(target);\n      }\n    }\n  }\n}\n\n\n/**\n * Registers an event listener on an event target. Inspired by\n * https://google.github.io/closure-library/api/source/closure/goog/events/events.js.src.html\n *\n * This function efficiently binds a `listener` to a `this` object, and returns\n * a key for use with {@link module:ol/events~unlistenByKey}.\n *\n * @param {import(\"./events/Target.js\").EventTargetLike} target Event target.\n * @param {string} type Event type.\n * @param {ListenerFunction} listener Listener.\n * @param {Object=} opt_this Object referenced by the `this` keyword in the\n *     listener. Default is the `target`.\n * @param {boolean=} opt_once If true, add the listener as one-off listener.\n * @return {EventsKey} Unique key for the listener.\n */\nexport function listen(target, type, listener, opt_this, opt_once) {\n  const listenerMap = getListenerMap(target, true);\n  let listeners = listenerMap[type];\n  if (!listeners) {\n    listeners = listenerMap[type] = [];\n  }\n  let listenerObj = findListener(listeners, listener, opt_this, false);\n  if (listenerObj) {\n    if (!opt_once) {\n      // Turn one-off listener into a permanent one.\n      listenerObj.callOnce = false;\n    }\n  } else {\n    listenerObj = /** @type {EventsKey} */ ({\n      bindTo: opt_this,\n      callOnce: !!opt_once,\n      listener: listener,\n      target: target,\n      type: type\n    });\n    /** @type {import(\"./events/Target.js\").default} */ (target).\n      addEventListener(type, bindListener(listenerObj));\n    listeners.push(listenerObj);\n  }\n\n  return listenerObj;\n}\n\n\n/**\n * Registers a one-off event listener on an event target. Inspired by\n * https://google.github.io/closure-library/api/source/closure/goog/events/events.js.src.html\n *\n * This function efficiently binds a `listener` as self-unregistering listener\n * to a `this` object, and returns a key for use with\n * {@link module:ol/events~unlistenByKey} in case the listener needs to be\n * unregistered before it is called.\n *\n * When {@link module:ol/events~listen} is called with the same arguments after this\n * function, the self-unregistering listener will be turned into a permanent\n * listener.\n *\n * @param {import(\"./events/Target.js\").EventTargetLike} target Event target.\n * @param {string} type Event type.\n * @param {ListenerFunction} listener Listener.\n * @param {Object=} opt_this Object referenced by the `this` keyword in the\n *     listener. Default is the `target`.\n * @return {EventsKey} Key for unlistenByKey.\n */\nexport function listenOnce(target, type, listener, opt_this) {\n  return listen(target, type, listener, opt_this, true);\n}\n\n\n/**\n * Unregisters an event listener on an event target. Inspired by\n * https://google.github.io/closure-library/api/source/closure/goog/events/events.js.src.html\n *\n * To return a listener, this function needs to be called with the exact same\n * arguments that were used for a previous {@link module:ol/events~listen} call.\n *\n * @param {import(\"./events/Target.js\").EventTargetLike} target Event target.\n * @param {string} type Event type.\n * @param {ListenerFunction} listener Listener.\n * @param {Object=} opt_this Object referenced by the `this` keyword in the\n *     listener. Default is the `target`.\n */\nexport function unlisten(target, type, listener, opt_this) {\n  const listeners = getListeners(target, type);\n  if (listeners) {\n    const listenerObj = findListener(listeners, listener, opt_this, true);\n    if (listenerObj) {\n      unlistenByKey(listenerObj);\n    }\n  }\n}\n\n\n/**\n * Unregisters event listeners on an event target. Inspired by\n * https://google.github.io/closure-library/api/source/closure/goog/events/events.js.src.html\n *\n * The argument passed to this function is the key returned from\n * {@link module:ol/events~listen} or {@link module:ol/events~listenOnce}.\n *\n * @param {EventsKey} key The key.\n */\nexport function unlistenByKey(key) {\n  if (key && key.target) {\n    /** @type {import(\"./events/Target.js\").default} */ (key.target).\n      removeEventListener(key.type, key.boundListener);\n    const listeners = getListeners(key.target, key.type);\n    if (listeners) {\n      const i = 'deleteIndex' in key ? key.deleteIndex : listeners.indexOf(key);\n      if (i !== -1) {\n        listeners.splice(i, 1);\n      }\n      if (listeners.length === 0) {\n        removeListeners(key.target, key.type);\n      }\n    }\n    clear(key);\n  }\n}\n\n\n/**\n * Unregisters all event listeners on an event target. Inspired by\n * https://google.github.io/closure-library/api/source/closure/goog/events/events.js.src.html\n *\n * @param {import(\"./events/Target.js\").EventTargetLike} target Target.\n */\nexport function unlistenAll(target) {\n  const listenerMap = getListenerMap(target);\n  if (listenerMap) {\n    for (const type in listenerMap) {\n      removeListeners(target, type);\n    }\n  }\n}\n"],"names":["const","let"],"mappings":"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"}