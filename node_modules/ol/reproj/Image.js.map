{"version":3,"file":"Image.js","sources":["../../../src/ol/reproj/Image.js"],"sourcesContent":["/**\n * @module ol/reproj/Image\n */\nimport {ERROR_THRESHOLD} from './common.js';\n\nimport ImageBase from '../ImageBase.js';\nimport ImageState from '../ImageState.js';\nimport {listen, unlistenByKey} from '../events.js';\nimport EventType from '../events/EventType.js';\nimport {getCenter, getIntersection, getHeight, getWidth} from '../extent.js';\nimport {calculateSourceResolution, render as renderReprojected} from '../reproj.js';\nimport Triangulation from './Triangulation.js';\n\n\n/**\n * @typedef {function(import(\"../extent.js\").Extent, number, number) : import(\"../ImageBase.js\").default} FunctionType\n */\n\n\n/**\n * @classdesc\n * Class encapsulating single reprojected image.\n * See {@link module:ol/source/Image~ImageSource}.\n */\nclass ReprojImage extends ImageBase {\n  /**\n   * @param {import(\"../proj/Projection.js\").default} sourceProj Source projection (of the data).\n   * @param {import(\"../proj/Projection.js\").default} targetProj Target projection.\n   * @param {import(\"../extent.js\").Extent} targetExtent Target extent.\n   * @param {number} targetResolution Target resolution.\n   * @param {number} pixelRatio Pixel ratio.\n   * @param {FunctionType} getImageFunction\n   *     Function returning source images (extent, resolution, pixelRatio).\n   */\n  constructor(sourceProj, targetProj, targetExtent, targetResolution, pixelRatio, getImageFunction) {\n    const maxSourceExtent = sourceProj.getExtent();\n    const maxTargetExtent = targetProj.getExtent();\n\n    const limitedTargetExtent = maxTargetExtent ?\n      getIntersection(targetExtent, maxTargetExtent) : targetExtent;\n\n    const targetCenter = getCenter(limitedTargetExtent);\n    const sourceResolution = calculateSourceResolution(\n      sourceProj, targetProj, targetCenter, targetResolution);\n\n    const errorThresholdInPixels = ERROR_THRESHOLD;\n\n    const triangulation = new Triangulation(\n      sourceProj, targetProj, limitedTargetExtent, maxSourceExtent,\n      sourceResolution * errorThresholdInPixels);\n\n    const sourceExtent = triangulation.calculateSourceExtent();\n    const sourceImage = getImageFunction(sourceExtent, sourceResolution, pixelRatio);\n    let state = ImageState.LOADED;\n    if (sourceImage) {\n      state = ImageState.IDLE;\n    }\n    const sourcePixelRatio = sourceImage ? sourceImage.getPixelRatio() : 1;\n\n    super(targetExtent, targetResolution, sourcePixelRatio, state);\n\n    /**\n     * @private\n     * @type {import(\"../proj/Projection.js\").default}\n     */\n    this.targetProj_ = targetProj;\n\n    /**\n     * @private\n     * @type {import(\"../extent.js\").Extent}\n     */\n    this.maxSourceExtent_ = maxSourceExtent;\n\n    /**\n     * @private\n     * @type {!import(\"./Triangulation.js\").default}\n     */\n    this.triangulation_ = triangulation;\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.targetResolution_ = targetResolution;\n\n    /**\n     * @private\n     * @type {import(\"../extent.js\").Extent}\n     */\n    this.targetExtent_ = targetExtent;\n\n    /**\n     * @private\n     * @type {import(\"../ImageBase.js\").default}\n     */\n    this.sourceImage_ = sourceImage;\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.sourcePixelRatio_ = sourcePixelRatio;\n\n    /**\n     * @private\n     * @type {HTMLCanvasElement}\n     */\n    this.canvas_ = null;\n\n    /**\n     * @private\n     * @type {?import(\"../events.js\").EventsKey}\n     */\n    this.sourceListenerKey_ = null;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  disposeInternal() {\n    if (this.state == ImageState.LOADING) {\n      this.unlistenSource_();\n    }\n    super.disposeInternal();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getImage() {\n    return this.canvas_;\n  }\n\n  /**\n   * @return {import(\"../proj/Projection.js\").default} Projection.\n   */\n  getProjection() {\n    return this.targetProj_;\n  }\n\n  /**\n   * @private\n   */\n  reproject_() {\n    const sourceState = this.sourceImage_.getState();\n    if (sourceState == ImageState.LOADED) {\n      const width = getWidth(this.targetExtent_) / this.targetResolution_;\n      const height = getHeight(this.targetExtent_) / this.targetResolution_;\n\n      this.canvas_ = renderReprojected(width, height, this.sourcePixelRatio_,\n        this.sourceImage_.getResolution(), this.maxSourceExtent_,\n        this.targetResolution_, this.targetExtent_, this.triangulation_, [{\n          extent: this.sourceImage_.getExtent(),\n          image: this.sourceImage_.getImage()\n        }], 0);\n    }\n    this.state = sourceState;\n    this.changed();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  load() {\n    if (this.state == ImageState.IDLE) {\n      this.state = ImageState.LOADING;\n      this.changed();\n\n      const sourceState = this.sourceImage_.getState();\n      if (sourceState == ImageState.LOADED || sourceState == ImageState.ERROR) {\n        this.reproject_();\n      } else {\n        this.sourceListenerKey_ = listen(this.sourceImage_,\n          EventType.CHANGE, function(e) {\n            const sourceState = this.sourceImage_.getState();\n            if (sourceState == ImageState.LOADED || sourceState == ImageState.ERROR) {\n              this.unlistenSource_();\n              this.reproject_();\n            }\n          }, this);\n        this.sourceImage_.load();\n      }\n    }\n  }\n\n  /**\n   * @private\n   */\n  unlistenSource_() {\n    unlistenByKey(/** @type {!import(\"../events.js\").EventsKey} */ (this.sourceListenerKey_));\n    this.sourceListenerKey_ = null;\n  }\n}\n\n\nexport default ReprojImage;\n"],"names":["const","let","super"],"mappings":"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"}