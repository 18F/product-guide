{"version":3,"file":"Map.js","sources":["../../../../src/ol/renderer/canvas/Map.js"],"sourcesContent":["/**\n * @module ol/renderer/canvas/Map\n */\nimport {create as createTransform, apply as applyTransform, compose as composeTransform} from '../../transform.js';\nimport {includes, stableSort} from '../../array.js';\nimport {CLASS_UNSELECTABLE} from '../../css.js';\nimport {createCanvasContext2D} from '../../dom.js';\nimport {visibleAtResolution} from '../../layer/Layer.js';\nimport RenderEvent from '../../render/Event.js';\nimport RenderEventType from '../../render/EventType.js';\nimport {rotateAtOffset} from '../../render/canvas.js';\nimport CanvasImmediateRenderer from '../../render/canvas/Immediate.js';\nimport MapRenderer, {sortByZIndex} from '../Map.js';\nimport SourceState from '../../source/State.js';\n\n\n/**\n * @type {Array<typeof import(\"../Layer.js\").default>}\n */\nexport const layerRendererConstructors = [];\n\n/**\n * @classdesc\n * Canvas map renderer.\n * @api\n */\nclass CanvasMapRenderer extends MapRenderer {\n\n  /**\n   * @param {import(\"../../PluggableMap.js\").default} map Map.\n   */\n  constructor(map) {\n    super(map);\n\n    const container = map.getViewport();\n\n    /**\n     * @private\n     * @type {CanvasRenderingContext2D}\n     */\n    this.context_ = createCanvasContext2D();\n\n    /**\n     * @private\n     * @type {HTMLCanvasElement}\n     */\n    this.canvas_ = this.context_.canvas;\n\n    this.canvas_.style.width = '100%';\n    this.canvas_.style.height = '100%';\n    this.canvas_.style.display = 'block';\n    this.canvas_.className = CLASS_UNSELECTABLE;\n    container.insertBefore(this.canvas_, container.childNodes[0] || null);\n\n    /**\n     * @private\n     * @type {boolean}\n     */\n    this.renderedVisible_ = true;\n\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.transform_ = createTransform();\n\n  }\n\n  /**\n   * @param {import(\"../../render/EventType.js\").default} type Event type.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n  dispatchRenderEvent(type, frameState) {\n    const map = this.getMap();\n    const context = this.context_;\n    if (map.hasListener(type)) {\n      const extent = frameState.extent;\n      const pixelRatio = frameState.pixelRatio;\n      const viewState = frameState.viewState;\n      const rotation = viewState.rotation;\n\n      const transform = this.getTransform(frameState);\n\n      const vectorContext = new CanvasImmediateRenderer(context, pixelRatio,\n        extent, transform, rotation);\n      const composeEvent = new RenderEvent(type, vectorContext,\n        frameState, context, null);\n      map.dispatchEvent(composeEvent);\n    }\n  }\n\n  /**\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @protected\n   * @return {!import(\"../../transform.js\").Transform} Transform.\n   */\n  getTransform(frameState) {\n    const viewState = frameState.viewState;\n    const dx1 = this.canvas_.width / 2;\n    const dy1 = this.canvas_.height / 2;\n    const sx = frameState.pixelRatio / viewState.resolution;\n    const sy = -sx;\n    const angle = -viewState.rotation;\n    const dx2 = -viewState.center[0];\n    const dy2 = -viewState.center[1];\n    return composeTransform(this.transform_, dx1, dy1, sx, sy, angle, dx2, dy2);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  renderFrame(frameState) {\n\n    if (!frameState) {\n      if (this.renderedVisible_) {\n        this.canvas_.style.display = 'none';\n        this.renderedVisible_ = false;\n      }\n      return;\n    }\n\n    const context = this.context_;\n    const pixelRatio = frameState.pixelRatio;\n    const width = Math.round(frameState.size[0] * pixelRatio);\n    const height = Math.round(frameState.size[1] * pixelRatio);\n    if (this.canvas_.width != width || this.canvas_.height != height) {\n      this.canvas_.width = width;\n      this.canvas_.height = height;\n    } else {\n      context.clearRect(0, 0, width, height);\n    }\n\n    const rotation = frameState.viewState.rotation;\n\n    this.calculateMatrices2D(frameState);\n\n    this.dispatchRenderEvent(RenderEventType.PRECOMPOSE, frameState);\n\n    const layerStatesArray = frameState.layerStatesArray;\n    stableSort(layerStatesArray, sortByZIndex);\n\n    if (rotation) {\n      context.save();\n      rotateAtOffset(context, rotation, width / 2, height / 2);\n    }\n\n    const viewResolution = frameState.viewState.resolution;\n    let i, ii;\n    for (i = 0, ii = layerStatesArray.length; i < ii; ++i) {\n      const layerState = layerStatesArray[i];\n      const layer = layerState.layer;\n      const layerRenderer = /** @type {import(\"./Layer.js\").default} */ (this.getLayerRenderer(layer));\n      if (!visibleAtResolution(layerState, viewResolution) ||\n          layerState.sourceState != SourceState.READY) {\n        continue;\n      }\n      if (layerRenderer.prepareFrame(frameState, layerState)) {\n        layerRenderer.composeFrame(frameState, layerState, context);\n      }\n    }\n\n    if (rotation) {\n      context.restore();\n    }\n\n    this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE, frameState);\n\n    if (!this.renderedVisible_) {\n      this.canvas_.style.display = '';\n      this.renderedVisible_ = true;\n    }\n\n    this.scheduleRemoveUnusedLayerRenderers(frameState);\n    this.scheduleExpireIconCache(frameState);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  forEachLayerAtPixel(pixel, frameState, hitTolerance, callback, thisArg, layerFilter, thisArg2) {\n    let result;\n    const viewState = frameState.viewState;\n    const viewResolution = viewState.resolution;\n\n    const layerStates = frameState.layerStatesArray;\n    const numLayers = layerStates.length;\n\n    const coordinate = applyTransform(\n      frameState.pixelToCoordinateTransform, pixel.slice());\n\n    let i;\n    for (i = numLayers - 1; i >= 0; --i) {\n      const layerState = layerStates[i];\n      const layer = layerState.layer;\n      if (visibleAtResolution(layerState, viewResolution) && layerFilter.call(thisArg2, layer)) {\n        const layerRenderer = /** @type {import(\"./Layer.js\").default} */ (this.getLayerRenderer(layer));\n        result = layerRenderer.forEachLayerAtCoordinate(\n          coordinate, frameState, hitTolerance, callback, thisArg);\n        if (result) {\n          return result;\n        }\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  registerLayerRenderers(constructors) {\n    super.registerLayerRenderers(constructors);\n    for (let i = 0, ii = constructors.length; i < ii; ++i) {\n      const ctor = constructors[i];\n      if (!includes(layerRendererConstructors, ctor)) {\n        layerRendererConstructors.push(ctor);\n      }\n    }\n  }\n}\n\n\nexport default CanvasMapRenderer;\n"],"names":["const","super","let"],"mappings":"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"}