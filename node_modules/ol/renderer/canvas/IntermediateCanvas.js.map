{"version":3,"file":"IntermediateCanvas.js","sources":["../../../../src/ol/renderer/canvas/IntermediateCanvas.js"],"sourcesContent":["/**\n * @module ol/renderer/canvas/IntermediateCanvas\n */\nimport {abstract} from '../../util.js';\nimport {scale as scaleCoordinate} from '../../coordinate.js';\nimport {createCanvasContext2D} from '../../dom.js';\nimport {containsExtent, intersects} from '../../extent.js';\nimport CanvasLayerRenderer from './Layer.js';\nimport {create as createTransform, apply as applyTransform} from '../../transform.js';\n\n/**\n * @abstract\n */\nclass IntermediateCanvasRenderer extends CanvasLayerRenderer {\n\n  /**\n   * @param {import(\"../../layer/Layer.js\").default} layer Layer.\n   */\n  constructor(layer) {\n\n    super(layer);\n\n    /**\n     * @protected\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.coordinateToCanvasPixelTransform = createTransform();\n\n    /**\n     * @private\n     * @type {CanvasRenderingContext2D}\n     */\n    this.hitCanvasContext_ = null;\n\n  }\n\n  /**\n   * @inheritDoc\n   */\n  composeFrame(frameState, layerState, context) {\n\n    this.preCompose(context, frameState);\n\n    const image = this.getImage();\n    if (image) {\n\n      // clipped rendering if layer extent is set\n      const extent = layerState.extent;\n      const clipped = extent !== undefined &&\n          !containsExtent(extent, frameState.extent) &&\n          intersects(extent, frameState.extent);\n      if (clipped) {\n        this.clip(context, frameState, /** @type {import(\"../../extent.js\").Extent} */ (extent));\n      }\n\n      const imageTransform = this.getImageTransform();\n      // for performance reasons, context.save / context.restore is not used\n      // to save and restore the transformation matrix and the opacity.\n      // see http://jsperf.com/context-save-restore-versus-variable\n      const alpha = context.globalAlpha;\n      context.globalAlpha = layerState.opacity;\n\n      // for performance reasons, context.setTransform is only used\n      // when the view is rotated. see http://jsperf.com/canvas-transform\n      const dx = imageTransform[4];\n      const dy = imageTransform[5];\n      const dw = image.width * imageTransform[0];\n      const dh = image.height * imageTransform[3];\n      if (dw >= 0.5 && dh >= 0.5) {\n        context.drawImage(image, 0, 0, +image.width, +image.height,\n          Math.round(dx), Math.round(dy), Math.round(dw), Math.round(dh));\n      }\n      context.globalAlpha = alpha;\n\n      if (clipped) {\n        context.restore();\n      }\n    }\n\n    this.postCompose(context, frameState, layerState);\n  }\n\n  /**\n   * @abstract\n   * @return {HTMLCanvasElement|HTMLVideoElement|HTMLImageElement} Canvas.\n   */\n  getImage() {\n    return abstract();\n  }\n\n  /**\n   * @abstract\n   * @return {!import(\"../../transform.js\").Transform} Image transform.\n   */\n  getImageTransform() {\n    return abstract();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  forEachLayerAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\n    if (!this.getImage()) {\n      return undefined;\n    }\n\n    const pixel = applyTransform(this.coordinateToCanvasPixelTransform, coordinate.slice());\n    scaleCoordinate(pixel, frameState.viewState.resolution / this.renderedResolution);\n\n    if (!this.hitCanvasContext_) {\n      this.hitCanvasContext_ = createCanvasContext2D(1, 1);\n    }\n\n    this.hitCanvasContext_.clearRect(0, 0, 1, 1);\n    this.hitCanvasContext_.drawImage(this.getImage(), pixel[0], pixel[1], 1, 1, 0, 0, 1, 1);\n\n    const imageData = this.hitCanvasContext_.getImageData(0, 0, 1, 1).data;\n    if (imageData[3] > 0) {\n      return callback.call(thisArg, this.getLayer(), imageData);\n    } else {\n      return undefined;\n    }\n  }\n}\n\n\nexport default IntermediateCanvasRenderer;\n"],"names":["super","const"],"mappings":"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"}