{"version":3,"file":"ImageLayer.js","sources":["../../../../src/ol/renderer/canvas/ImageLayer.js"],"sourcesContent":["/**\n * @module ol/renderer/canvas/ImageLayer\n */\nimport {ENABLE_RASTER_REPROJECTION} from '../../reproj/common.js';\nimport ImageCanvas from '../../ImageCanvas.js';\nimport LayerType from '../../LayerType.js';\nimport ViewHint from '../../ViewHint.js';\nimport {equals} from '../../array.js';\nimport {getHeight, getIntersection, getWidth, isEmpty} from '../../extent.js';\nimport VectorRenderType from '../../layer/VectorRenderType.js';\nimport {assign} from '../../obj.js';\nimport {layerRendererConstructors} from './Map.js';\nimport IntermediateCanvasRenderer from './IntermediateCanvas.js';\nimport {create as createTransform, compose as composeTransform} from '../../transform.js';\n\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\nclass CanvasImageLayerRenderer extends IntermediateCanvasRenderer {\n\n  /**\n   * @param {import(\"../../layer/Image.js\").default|import(\"../../layer/Vector.js\").default} imageLayer Image or vector layer.\n   */\n  constructor(imageLayer) {\n\n    super(imageLayer);\n\n    /**\n     * @private\n     * @type {?import(\"../../ImageBase.js\").default}\n     */\n    this.image_ = null;\n\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.imageTransform_ = createTransform();\n\n    /**\n     * @type {!Array<string>}\n     */\n    this.skippedFeatures_ = [];\n\n    /**\n     * @private\n     * @type {import(\"./VectorLayer.js\").default}\n     */\n    this.vectorRenderer_ = null;\n\n    if (imageLayer.getType() === LayerType.VECTOR) {\n      for (let i = 0, ii = layerRendererConstructors.length; i < ii; ++i) {\n        const ctor = layerRendererConstructors[i];\n        if (ctor !== CanvasImageLayerRenderer && ctor['handles'](imageLayer)) {\n          this.vectorRenderer_ = /** @type {import(\"./VectorLayer.js\").default} */ (new ctor(imageLayer));\n          break;\n        }\n      }\n    }\n\n  }\n\n  /**\n   * @inheritDoc\n   */\n  disposeInternal() {\n    if (this.vectorRenderer_) {\n      this.vectorRenderer_.dispose();\n    }\n    super.disposeInternal();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getImage() {\n    return !this.image_ ? null : this.image_.getImage();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getImageTransform() {\n    return this.imageTransform_;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  prepareFrame(frameState, layerState) {\n\n    const pixelRatio = frameState.pixelRatio;\n    const size = frameState.size;\n    const viewState = frameState.viewState;\n    const viewCenter = viewState.center;\n    const viewResolution = viewState.resolution;\n\n    let image;\n    const imageLayer = /** @type {import(\"../../layer/Image.js\").default} */ (this.getLayer());\n    const imageSource = /** @type {import(\"../../source/Image.js\").default} */ (imageLayer.getSource());\n\n    const hints = frameState.viewHints;\n\n    const vectorRenderer = this.vectorRenderer_;\n    let renderedExtent = frameState.extent;\n    if (!vectorRenderer && layerState.extent !== undefined) {\n      renderedExtent = getIntersection(renderedExtent, layerState.extent);\n    }\n\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] &&\n        !isEmpty(renderedExtent)) {\n      let projection = viewState.projection;\n      if (!ENABLE_RASTER_REPROJECTION) {\n        const sourceProjection = imageSource.getProjection();\n        if (sourceProjection) {\n          projection = sourceProjection;\n        }\n      }\n      let skippedFeatures = this.skippedFeatures_;\n      if (vectorRenderer) {\n        const context = vectorRenderer.context;\n        const imageFrameState = /** @type {import(\"../../PluggableMap.js\").FrameState} */ (assign({}, frameState, {\n          size: [\n            getWidth(renderedExtent) / viewResolution,\n            getHeight(renderedExtent) / viewResolution\n          ],\n          viewState: /** @type {import(\"../../View.js\").State} */ (assign({}, frameState.viewState, {\n            rotation: 0\n          }))\n        }));\n        const newSkippedFeatures = Object.keys(imageFrameState.skippedFeatureUids).sort();\n        image = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function(callback) {\n          if (vectorRenderer.prepareFrame(imageFrameState, layerState) &&\n              (vectorRenderer.replayGroupChanged ||\n              !equals(skippedFeatures, newSkippedFeatures))) {\n            context.canvas.width = imageFrameState.size[0] * pixelRatio;\n            context.canvas.height = imageFrameState.size[1] * pixelRatio;\n            vectorRenderer.compose(context, imageFrameState, layerState);\n            skippedFeatures = newSkippedFeatures;\n            callback();\n          }\n        });\n      } else {\n        image = imageSource.getImage(\n          renderedExtent, viewResolution, pixelRatio, projection);\n      }\n      if (image && this.loadImage(image)) {\n        this.image_ = image;\n        this.skippedFeatures_ = skippedFeatures;\n      }\n    }\n\n    if (this.image_) {\n      image = this.image_;\n      const imageExtent = image.getExtent();\n      const imageResolution = image.getResolution();\n      const imagePixelRatio = image.getPixelRatio();\n      const scale = pixelRatio * imageResolution /\n          (viewResolution * imagePixelRatio);\n      const transform = composeTransform(this.imageTransform_,\n        pixelRatio * size[0] / 2, pixelRatio * size[1] / 2,\n        scale, scale,\n        0,\n        imagePixelRatio * (imageExtent[0] - viewCenter[0]) / imageResolution,\n        imagePixelRatio * (viewCenter[1] - imageExtent[3]) / imageResolution);\n      composeTransform(this.coordinateToCanvasPixelTransform,\n        pixelRatio * size[0] / 2 - transform[4], pixelRatio * size[1] / 2 - transform[5],\n        pixelRatio / viewResolution, -pixelRatio / viewResolution,\n        0,\n        -viewCenter[0], -viewCenter[1]);\n\n      this.renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\n    }\n\n    return !!this.image_;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback) {\n    if (this.vectorRenderer_) {\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback);\n    } else {\n      return super.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback);\n    }\n  }\n}\n\n\n/**\n * Determine if this renderer handles the provided layer.\n * @param {import(\"../../layer/Layer.js\").default} layer The candidate layer.\n * @return {boolean} The renderer can render the layer.\n */\nCanvasImageLayerRenderer['handles'] = function(layer) {\n  return layer.getType() === LayerType.IMAGE ||\n    layer.getType() === LayerType.VECTOR &&\n    /** @type {import(\"../../layer/Vector.js\").default} */ (layer).getRenderMode() === VectorRenderType.IMAGE;\n};\n\n\n/**\n * Create a layer renderer.\n * @param {import(\"../Map.js\").default} mapRenderer The map renderer.\n * @param {import(\"../../layer/Layer.js\").default} layer The layer to be rendererd.\n * @return {CanvasImageLayerRenderer} The layer renderer.\n */\nCanvasImageLayerRenderer['create'] = function(mapRenderer, layer) {\n  return new CanvasImageLayerRenderer(/** @type {import(\"../../layer/Image.js\").default} */ (layer));\n};\n\n\nexport default CanvasImageLayerRenderer;\n"],"names":["super","let","const"],"mappings":"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"}