{"version":3,"file":"Layer.js","sources":["../../../../src/ol/renderer/webgl/Layer.js"],"sourcesContent":["/**\n * @module ol/renderer/webgl/Layer\n */\nimport {abstract} from '../../util.js';\nimport RenderEvent from '../../render/Event.js';\nimport RenderEventType from '../../render/EventType.js';\nimport WebGLImmediateRenderer from '../../render/webgl/Immediate.js';\nimport LayerRenderer from '../Layer.js';\nimport {fragment, vertex} from './defaultmapshader.js';\nimport Locations from './defaultmapshader/Locations.js';\nimport {create as createTransform} from '../../transform.js';\nimport {create, fromTransform} from '../../vec/mat4.js';\nimport {ARRAY_BUFFER, FRAMEBUFFER, FLOAT, TEXTURE_2D,\n  TRIANGLE_STRIP, COLOR_ATTACHMENT0} from '../../webgl.js';\nimport WebGLBuffer from '../../webgl/Buffer.js';\nimport {createEmptyTexture} from '../../webgl/Context.js';\n\n/**\n * @abstract\n */\nclass WebGLLayerRenderer extends LayerRenderer {\n\n  /**\n   * @param {import(\"./Map.js\").default} mapRenderer Map renderer.\n   * @param {import(\"../../layer/Layer.js\").default} layer Layer.\n   */\n  constructor(mapRenderer, layer) {\n\n    super(layer);\n\n    /**\n     * @protected\n     * @type {import(\"./Map.js\").default}\n     */\n    this.mapRenderer = mapRenderer;\n\n    /**\n     * @private\n     * @type {import(\"../../webgl/Buffer.js\").default}\n     */\n    this.arrayBuffer_ = new WebGLBuffer([\n      -1, -1, 0, 0,\n      1, -1, 1, 0,\n      -1, 1, 0, 1,\n      1, 1, 1, 1\n    ]);\n\n    /**\n     * @protected\n     * @type {WebGLTexture}\n     */\n    this.texture = null;\n\n    /**\n     * @protected\n     * @type {WebGLFramebuffer}\n     */\n    this.framebuffer = null;\n\n    /**\n     * @protected\n     * @type {number|undefined}\n     */\n    this.framebufferDimension = undefined;\n\n    /**\n     * @protected\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.texCoordMatrix = createTransform();\n\n    /**\n     * @protected\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    this.projectionMatrix = createTransform();\n\n    /**\n     * @type {Array<number>}\n     * @private\n     */\n    this.tmpMat4_ = create();\n\n    /**\n     * @private\n     * @type {import(\"./defaultmapshader/Locations.js\").default}\n     */\n    this.defaultLocations_ = null;\n\n  }\n\n  /**\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @param {number} framebufferDimension Framebuffer dimension.\n   * @protected\n   */\n  bindFramebuffer(frameState, framebufferDimension) {\n\n    const gl = this.mapRenderer.getGL();\n\n    if (this.framebufferDimension === undefined ||\n        this.framebufferDimension != framebufferDimension) {\n      /**\n       * @param {WebGLRenderingContext} gl GL.\n       * @param {WebGLFramebuffer} framebuffer Framebuffer.\n       * @param {WebGLTexture} texture Texture.\n       */\n      const postRenderFunction = function(gl, framebuffer, texture) {\n        if (!gl.isContextLost()) {\n          gl.deleteFramebuffer(framebuffer);\n          gl.deleteTexture(texture);\n        }\n      }.bind(null, gl, this.framebuffer, this.texture);\n\n      frameState.postRenderFunctions.push(\n        /** @type {import(\"../../PluggableMap.js\").PostRenderFunction} */ (postRenderFunction)\n      );\n\n      const texture = createEmptyTexture(\n        gl, framebufferDimension, framebufferDimension);\n\n      const framebuffer = gl.createFramebuffer();\n      gl.bindFramebuffer(FRAMEBUFFER, framebuffer);\n      gl.framebufferTexture2D(FRAMEBUFFER,\n        COLOR_ATTACHMENT0, TEXTURE_2D, texture, 0);\n\n      this.texture = texture;\n      this.framebuffer = framebuffer;\n      this.framebufferDimension = framebufferDimension;\n\n    } else {\n      gl.bindFramebuffer(FRAMEBUFFER, this.framebuffer);\n    }\n\n  }\n\n  /**\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @param {import(\"../../layer/Layer.js\").State} layerState Layer state.\n   * @param {import(\"../../webgl/Context.js\").default} context Context.\n   */\n  composeFrame(frameState, layerState, context) {\n\n    this.dispatchComposeEvent_(RenderEventType.PRECOMPOSE, context, frameState);\n\n    context.bindBuffer(ARRAY_BUFFER, this.arrayBuffer_);\n\n    const gl = context.getGL();\n\n    const program = context.getProgram(fragment, vertex);\n\n    let locations;\n    if (!this.defaultLocations_) {\n      locations = new Locations(gl, program);\n      this.defaultLocations_ = locations;\n    } else {\n      locations = this.defaultLocations_;\n    }\n\n    if (context.useProgram(program)) {\n      gl.enableVertexAttribArray(locations.a_position);\n      gl.vertexAttribPointer(\n        locations.a_position, 2, FLOAT, false, 16, 0);\n      gl.enableVertexAttribArray(locations.a_texCoord);\n      gl.vertexAttribPointer(\n        locations.a_texCoord, 2, FLOAT, false, 16, 8);\n      gl.uniform1i(locations.u_texture, 0);\n    }\n\n    gl.uniformMatrix4fv(locations.u_texCoordMatrix, false,\n      fromTransform(this.tmpMat4_, this.getTexCoordMatrix()));\n    gl.uniformMatrix4fv(locations.u_projectionMatrix, false,\n      fromTransform(this.tmpMat4_, this.getProjectionMatrix()));\n    gl.uniform1f(locations.u_opacity, layerState.opacity);\n    gl.bindTexture(TEXTURE_2D, this.getTexture());\n    gl.drawArrays(TRIANGLE_STRIP, 0, 4);\n\n    this.dispatchComposeEvent_(RenderEventType.POSTCOMPOSE, context, frameState);\n  }\n\n  /**\n   * @param {import(\"../../render/EventType.js\").default} type Event type.\n   * @param {import(\"../../webgl/Context.js\").default} context WebGL context.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @private\n   */\n  dispatchComposeEvent_(type, context, frameState) {\n    const layer = this.getLayer();\n    if (layer.hasListener(type)) {\n      const viewState = frameState.viewState;\n      const resolution = viewState.resolution;\n      const pixelRatio = frameState.pixelRatio;\n      const extent = frameState.extent;\n      const center = viewState.center;\n      const rotation = viewState.rotation;\n      const size = frameState.size;\n\n      const render = new WebGLImmediateRenderer(\n        context, center, resolution, rotation, size, extent, pixelRatio);\n      const composeEvent = new RenderEvent(\n        type, render, frameState, null, context);\n      layer.dispatchEvent(composeEvent);\n    }\n  }\n\n  /**\n   * @return {!import(\"../../transform.js\").Transform} Matrix.\n   */\n  getTexCoordMatrix() {\n    return this.texCoordMatrix;\n  }\n\n  /**\n   * @return {WebGLTexture} Texture.\n   */\n  getTexture() {\n    return this.texture;\n  }\n\n  /**\n   * @return {!import(\"../../transform.js\").Transform} Matrix.\n   */\n  getProjectionMatrix() {\n    return this.projectionMatrix;\n  }\n\n  /**\n   * Handle webglcontextlost.\n   */\n  handleWebGLContextLost() {\n    this.texture = null;\n    this.framebuffer = null;\n    this.framebufferDimension = undefined;\n  }\n\n  /**\n   * @abstract\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @param {import(\"../../layer/Layer.js\").State} layerState Layer state.\n   * @param {import(\"../../webgl/Context.js\").default} context Context.\n   * @return {boolean} whether composeFrame should be called.\n   */\n  prepareFrame(frameState, layerState, context) {\n    return abstract();\n  }\n\n  /**\n   * @abstract\n   * @param {import(\"../../pixel.js\").Pixel} pixel Pixel.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {function(this: S, import(\"../../layer/Layer.js\").default, (Uint8ClampedArray|Uint8Array)): T} callback Layer\n   *     callback.\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\n   * @return {T|undefined} Callback result.\n   * @template S,T,U\n   */\n  forEachLayerAtPixel(pixel, frameState, callback, thisArg) {\n    return abstract();\n  }\n}\n\n\nexport default WebGLLayerRenderer;\n"],"names":["super","const","let"],"mappings":"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"}